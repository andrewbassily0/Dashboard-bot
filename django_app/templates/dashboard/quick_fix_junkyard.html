{% extends 'dashboard/base.html' %}

{% block title %}إصلاح سريع للتشليح{% endblock %}

{% block page_title %}إصلاح سريع للتشليح{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="glass-card p-6 rounded-xl animate-fade-up">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center space-x-4 rtl:space-x-reverse">
                <div class="w-16 h-16 bg-orange-500 rounded-full flex items-center justify-center text-white text-xl font-bold">
                    🔧
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">
                        إصلاح سريع: {{ junkyard.user.first_name }}
                    </h1>
                    <p class="text-slate-600 dark:text-slate-400">
                        حل مشكلة "حدث خطأ" عند الضغط على "إضافة عرض"
                    </p>
                </div>
            </div>
            <div class="flex items-center space-x-4 rtl:space-x-reverse">
                <a href="{% url 'dashboard:junkyard_detail' junkyard.id %}" class="btn-secondary">
                    <i class="fas fa-arrow-right mr-2"></i>
                    العودة للتفاصيل
                </a>
            </div>
        </div>
    </div>

    <!-- Quick Status -->
    <div class="glass-card rounded-xl p-6 animate-fade-up" style="animation-delay: 0.1s">
        <div class="flex items-center mb-4">
            <i class="fas fa-tachometer-alt text-primary-500 ml-2"></i>
            <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">الحالة السريعة</h3>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="text-center p-4 rounded-lg {% if junkyard.user.telegram_id %}bg-green-50 border-green-200{% else %}bg-red-50 border-red-200{% endif %} border">
                <div class="text-2xl mb-2">
                    {% if junkyard.user.telegram_id %}✅{% else %}❌{% endif %}
                </div>
                <div class="font-semibold text-sm">معرف التليجرام</div>
                <div class="text-xs text-slate-600">{{ junkyard.user.telegram_id|default:"غير موجود" }}</div>
            </div>
            
            <div class="text-center p-4 rounded-lg {% if junkyard.user.user_type == 'junkyard' %}bg-green-50 border-green-200{% else %}bg-red-50 border-red-200{% endif %} border">
                <div class="text-2xl mb-2">
                    {% if junkyard.user.user_type == 'junkyard' %}✅{% else %}❌{% endif %}
                </div>
                <div class="font-semibold text-sm">نوع المستخدم</div>
                <div class="text-xs text-slate-600">{{ junkyard.user.user_type }}</div>
            </div>
            
            <div class="text-center p-4 rounded-lg {% if junkyard.is_active %}bg-green-50 border-green-200{% else %}bg-red-50 border-red-200{% endif %} border">
                <div class="text-2xl mb-2">
                    {% if junkyard.is_active %}✅{% else %}❌{% endif %}
                </div>
                <div class="font-semibold text-sm">حالة التشليح</div>
                <div class="text-xs text-slate-600">{% if junkyard.is_active %}مُفعل{% else %}غير مُفعل{% endif %}</div>
            </div>
            
            <div class="text-center p-4 rounded-lg {% if junkyard.city.is_active %}bg-green-50 border-green-200{% else %}bg-yellow-50 border-yellow-200{% endif %} border">
                <div class="text-2xl mb-2">
                    {% if junkyard.city.is_active %}✅{% else %}⚠️{% endif %}
                </div>
                <div class="font-semibold text-sm">المدينة</div>
                <div class="text-xs text-slate-600">{{ junkyard.city.name }}</div>
            </div>
        </div>
    </div>

    <!-- Issues & Quick Fixes -->
    {% if issues %}
    <div class="glass-card rounded-xl p-6 animate-fade-up" style="animation-delay: 0.2s">
        <div class="flex items-center mb-6">
            <i class="fas fa-exclamation-triangle text-red-500 ml-2"></i>
            <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">مشاكل تحتاج إصلاح</h3>
            <span class="badge-glass bg-red-100 text-red-600 border-red-200 mr-2">{{ issues|length }}</span>
        </div>
        
        <div class="space-y-4">
            {% for issue in issues %}
            <div class="{% if issue.type == 'critical' %}bg-red-50 border-red-200{% else %}bg-yellow-50 border-yellow-200{% endif %} border rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="font-medium {% if issue.type == 'critical' %}text-red-800{% else %}text-yellow-800{% endif %}">
                            {{ issue.message }}
                        </p>
                        {% if issue.fix and 'يجب' in issue.fix %}
                        <p class="text-sm {% if issue.type == 'critical' %}text-red-600{% else %}text-yellow-600{% endif %} mt-1">
                            💡 {{ issue.fix }}
                        </p>
                        {% endif %}
                    </div>
                    {% if issue.fix and issue.fix_label %}
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="{{ issue.fix }}">
                        <button type="submit" class="btn-warning text-sm" 
                                onclick="return confirm('هل تريد تطبيق هذا الإصلاح؟')">
                            {{ issue.fix_label }}
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="glass-card rounded-xl p-6 animate-fade-up" style="animation-delay: 0.3s">
        <div class="flex items-center mb-6">
            <i class="fas fa-bolt text-primary-500 ml-2"></i>
            <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">إجراءات سريعة</h3>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% if can_test_telegram %}
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="test_telegram">
                <button type="submit" class="btn-primary w-full">
                    <i class="fas fa-paper-plane mr-2"></i>
                    اختبار الرسائل
                </button>
            </form>
            {% else %}
            <div class="btn-glass w-full opacity-50 cursor-not-allowed">
                <i class="fas fa-paper-plane mr-2"></i>
                اختبار الرسائل (غير متاح)
            </div>
            {% endif %}
            
            <a href="{% url 'dashboard:test_junkyard_notification' junkyard.id %}" class="btn-secondary w-full text-center">
                <i class="fas fa-bell mr-2"></i>
                اختبار الإشعارات
            </a>
            
            <a href="{% url 'dashboard:edit_junkyard' junkyard.id %}" class="btn-secondary w-full text-center">
                <i class="fas fa-edit mr-2"></i>
                تعديل البيانات
            </a>
            
            <a href="{% url 'dashboard:diagnose_junkyard_issues' junkyard.id %}" class="btn-glass w-full text-center">
                <i class="fas fa-stethoscope mr-2"></i>
                تشخيص مفصل
            </a>
        </div>
    </div>

    <!-- Activity Summary -->
    <div class="glass-card rounded-xl p-6 animate-fade-up" style="animation-delay: 0.4s">
        <div class="flex items-center mb-4">
            <i class="fas fa-chart-line text-primary-500 ml-2"></i>
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">ملخص النشاط</h3>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
            <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                <div class="text-2xl font-bold text-primary-600">{{ total_offers }}</div>
                <div class="text-sm text-slate-600 dark:text-slate-400">إجمالي العروض</div>
            </div>
            
            <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                <div class="text-2xl font-bold text-green-600">{{ recent_offers }}</div>
                <div class="text-sm text-slate-600 dark:text-slate-400">عروض الأسبوع الماضي</div>
            </div>
            
            <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg">
                <div class="text-2xl font-bold text-blue-600">{{ junkyard.city.name }}</div>
                <div class="text-sm text-slate-600 dark:text-slate-400">المدينة</div>
            </div>
        </div>
    </div>

    <!-- Step by Step Guide -->
    <div class="glass-card rounded-xl p-6 animate-fade-up" style="animation-delay: 0.5s">
        <div class="flex items-center mb-4">
            <i class="fas fa-list-ol text-primary-500 ml-2"></i>
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">دليل حل المشكلة خطوة بخطوة</h3>
        </div>
        
        <div class="space-y-4">
            <div class="flex items-start space-x-3 rtl:space-x-reverse">
                <div class="bg-primary-100 text-primary-600 text-sm font-bold px-2 py-1 rounded-full mt-1">1</div>
                <div>
                    <h4 class="font-semibold text-slate-800 dark:text-slate-200">تحقق من المشاكل أعلاه</h4>
                    <p class="text-sm text-slate-600 dark:text-slate-400">استخدم أزرار الإصلاح السريع لحل المشاكل الحرجة</p>
                </div>
            </div>
            
            <div class="flex items-start space-x-3 rtl:space-x-reverse">
                <div class="bg-primary-100 text-primary-600 text-sm font-bold px-2 py-1 rounded-full mt-1">2</div>
                <div>
                    <h4 class="font-semibold text-slate-800 dark:text-slate-200">اختبر الاتصال</h4>
                    <p class="text-sm text-slate-600 dark:text-slate-400">اضغط "اختبار الرسائل" للتأكد من وصول الرسائل</p>
                </div>
            </div>
            
            <div class="flex items-start space-x-3 rtl:space-x-reverse">
                <div class="bg-primary-100 text-primary-600 text-sm font-bold px-2 py-1 rounded-full mt-1">3</div>
                <div>
                    <h4 class="font-semibold text-slate-800 dark:text-slate-200">أخبر التشليح بإرسال /start</h4>
                    <p class="text-sm text-slate-600 dark:text-slate-400">إذا فشل الاختبار، يجب على التشليح إرسال /start للبوت</p>
                </div>
            </div>
            
            <div class="flex items-start space-x-3 rtl:space-x-reverse">
                <div class="bg-primary-100 text-primary-600 text-sm font-bold px-2 py-1 rounded-full mt-1">4</div>
                <div>
                    <h4 class="font-semibold text-slate-800 dark:text-slate-200">اختبر مرة أخرى</h4>
                    <p class="text-sm text-slate-600 dark:text-slate-400">أعد اختبار الرسائل والتأكد من أن "إضافة عرض" يعمل</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Info -->
    <div class="glass-card rounded-xl p-6 animate-fade-up" style="animation-delay: 0.6s">
        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border-r-4 border-blue-500">
            <h4 class="font-semibold text-blue-800 dark:text-blue-300 mb-2">💡 معلومات للتواصل مع التشليح:</h4>
            <div class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                <p><strong>الاسم:</strong> {{ junkyard.user.first_name }} {{ junkyard.user.last_name }}</p>
                <p><strong>الهاتف:</strong> {{ junkyard.phone }}</p>
                {% if junkyard.user.telegram_username %}
                <p><strong>Telegram:</strong> @{{ junkyard.user.telegram_username }}</p>
                {% endif %}
                <p><strong>المدينة:</strong> {{ junkyard.city.name }}</p>
            </div>
        </div>
    </div>
</div>

<script>
// Auto refresh every 30 seconds
setTimeout(() => {
    window.location.reload();
}, 30000);

// Confirm actions
document.querySelectorAll('form[method="post"]').forEach(form => {
    form.addEventListener('submit', function(e) {
        const action = this.querySelector('input[name="action"]').value;
        if (action && !this.querySelector('button').onclick) {
            if (!confirm('هل تريد تطبيق هذا الإجراء؟')) {
                e.preventDefault();
            }
        }
    });
});
</script>
{% endblock %}
