{% extends 'dashboard/base.html' %}

{% block title %}تشاليح - تفاصيل المخزن{% endblock %}

{% block page_title %}تفاصيل المخزن{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="glass-card p-6 rounded-xl animate-fade-up">
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center space-x-4 rtl:space-x-reverse">
                <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center text-white text-xl font-bold">
                    {{ junkyard.user.first_name|first|default:"م"|upper }}
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">
                        {{ junkyard.user.first_name|default:"مخزن قطع غيار" }}
                    </h1>
                    <p class="text-slate-600 dark:text-slate-400">
                        {{ junkyard.city.name }} - {{ junkyard.location }}
                    </p>
                </div>
            </div>
            <div class="flex items-center space-x-4 rtl:space-x-reverse">
                {% if junkyard.is_verified %}
                    <span class="badge-glass status-completed">
                        <i class="fas fa-check-circle ml-1"></i>
                        مخزن معتمد
                    </span>
                {% endif %}
                <div class="flex items-center space-x-3 rtl:space-x-reverse">
                    <a href="{% url 'dashboard:edit_junkyard' junkyard.id %}" class="btn-primary">
                        <i class="fas fa-edit mr-2"></i>
                        تعديل التشليح
                    </a>
                    <a href="{% url 'dashboard:junkyards_list' %}" class="btn-secondary">
                        <i class="fas fa-arrow-right mr-2"></i>
                        العودة للقائمة
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Junkyard Info -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Info -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Basic Info -->
            <div class="glass-card rounded-xl p-6 animate-fade-up" style="animation-delay: 0.1s">
                <div class="flex items-center mb-6">
                    <svg class="w-6 h-6 ml-2 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100">معلومات المخزن</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">الاسم</label>
                        <p class="text-lg font-medium text-slate-900 dark:text-slate-100">
                            {{ junkyard.user.first_name|default:"مخزن قطع غيار" }}
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">المدينة</label>
                        <p class="text-lg font-medium text-slate-900 dark:text-slate-100">
                            {{ junkyard.city.name }}
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">رقم الهاتف</label>
                        <p class="text-lg font-medium text-slate-900 dark:text-slate-100">
                            <a href="tel:{{ junkyard.phone }}" class="text-primary-500 hover:text-primary-600">
                                <i class="fas fa-phone ml-1"></i>
                                {{ junkyard.phone }}
                            </a>
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">تاريخ التسجيل</label>
                        <p class="text-lg font-medium text-slate-900 dark:text-slate-100">
                            {{ junkyard.created_at|date:"Y/m/d" }}
                        </p>
                    </div>
                    
                    {% if junkyard.user.telegram_username %}
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">معرف التليجرام</label>
                        <p class="text-lg font-medium text-slate-900 dark:text-slate-100">
                            <a href="https://t.me/{{ junkyard.user.telegram_username }}" target="_blank" class="text-primary-500 hover:text-primary-600">
                                <i class="fab fa-telegram ml-1"></i>
                                @{{ junkyard.user.telegram_username }}
                            </a>
                        </p>
                    </div>
                    {% endif %}
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">الحالة</label>
                        <div class="flex items-center space-x-2 rtl:space-x-reverse">
                            {% if junkyard.is_active %}
                                <span class="badge-glass status-active">
                                    <i class="fas fa-circle ml-1"></i>
                                    نشط
                                </span>
                            {% else %}
                                <span class="badge-glass status-expired">
                                    <i class="fas fa-circle ml-1"></i>
                                    غير نشط
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {% if junkyard.location %}
                <div class="mt-6">
                    <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-2">الموقع</label>
                    <p class="text-slate-900 dark:text-slate-100 bg-slate-100 dark:bg-slate-800 p-3 rounded-lg">
                        {{ junkyard.location }}
                    </p>
                </div>
                {% endif %}
            </div>

            <!-- Recent Offers -->
            <div class="glass-card rounded-xl overflow-hidden animate-fade-up" style="animation-delay: 0.2s">
                <div class="px-6 py-4 border-b border-white/10 dark:border-slate-600/10 bg-primary-50/50 dark:bg-primary-900/10">
                    <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 flex items-center">
                        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                        </svg>
                        أحدث العروض ({{ offers|length }})
                    </h3>
                </div>
                
                <div class="p-6">
                    {% if offers %}
                        <div class="space-y-4">
                            {% for offer in offers %}
                            <div class="glass-card-hover p-4 rounded-lg border border-white/10 dark:border-slate-600/10">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3 rtl:space-x-reverse mb-2">
                                            <span class="font-semibold text-slate-900 dark:text-slate-100">
                                                طلب #{{ offer.request.order_id }}
                                            </span>
                                            <span class="text-sm text-slate-600 dark:text-slate-400">
                                                {{ offer.request.brand.name }} {{ offer.request.model.name }}
                                            </span>
                                        </div>
                                        <p class="text-sm text-slate-700 dark:text-slate-300 mb-1">
                                            السعر: {{ offer.price }} ج.م
                                        </p>
                                        {% if offer.notes %}
                                        <p class="text-xs text-slate-500 dark:text-slate-400">
                                            {{ offer.notes|truncatechars:100 }}
                                        </p>
                                        {% endif %}
                                    </div>
                                    <div class="text-left rtl:text-right">
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">
                                            {{ offer.created_at|date:"Y/m/d H:i" }}
                                        </p>
                                        <a href="{% url 'dashboard:request_detail' offer.request.id %}" class="btn-glass px-2 py-1 text-xs">
                                            عرض الطلب
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <svg class="w-12 h-12 text-slate-400 dark:text-slate-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <p class="text-slate-500 dark:text-slate-400">لا توجد عروض حديثة</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Statistics Sidebar -->
        <div class="space-y-6">
            <!-- Rating -->
            <div class="glass-card rounded-xl p-6 animate-fade-up" style="animation-delay: 0.3s">
                <div class="text-center">
                    <div class="w-20 h-20 bg-yellow-100 dark:bg-yellow-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-star text-2xl text-yellow-500"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-slate-900 dark:text-slate-100 mb-2">
                        {{ junkyard.average_rating|floatformat:1 }}
                    </h3>
                    <p class="text-slate-600 dark:text-slate-400 mb-4">متوسط التقييم</p>
                    
                    <div class="flex items-center justify-center space-x-1 rtl:space-x-reverse mb-2">
                        {% with rating=junkyard.average_rating|floatformat:0 %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= rating %}
                                    <i class="fas fa-star text-yellow-400"></i>
                                {% else %}
                                    <i class="far fa-star text-yellow-400"></i>
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                    </div>
                    
                    <p class="text-sm text-slate-500 dark:text-slate-400">
                        ({{ junkyard.total_ratings }} تقييم)
                    </p>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="glass-card rounded-xl p-6 animate-fade-up" style="animation-delay: 0.4s">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-4 flex items-center">
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    إحصائيات سريعة
                </h3>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-slate-600 dark:text-slate-400">إجمالي العروض</span>
                        <span class="font-semibold text-slate-900 dark:text-slate-100">{{ offers|length }}</span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-slate-600 dark:text-slate-400">التقييمات</span>
                        <span class="font-semibold text-slate-900 dark:text-slate-100">{{ ratings|length }}</span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-slate-600 dark:text-slate-400">عضو منذ</span>
                        <span class="font-semibold text-slate-900 dark:text-slate-100">{{ junkyard.created_at|date:"M Y" }}</span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="glass-card rounded-xl p-6 animate-fade-up" style="animation-delay: 0.5s">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-4">إجراءات</h3>
                
                <div class="space-y-3">
                    <a href="tel:{{ junkyard.phone }}" class="btn-primary w-full text-center">
                        <i class="fas fa-phone mr-2"></i>
                        اتصال
                    </a>
                    
                    {% if junkyard.user.telegram_username %}
                    <a href="https://t.me/{{ junkyard.user.telegram_username }}" target="_blank" class="btn-secondary w-full text-center">
                        <i class="fab fa-telegram mr-2"></i>
                        رسالة تليجرام
                    </a>
                    {% endif %}
                    
                    <button class="btn-glass w-full" onclick="copyToClipboard('{{ junkyard.phone }}')">
                        <i class="fas fa-copy mr-2"></i>
                        نسخ رقم الهاتف
                    </button>
                    
                    <!-- Test Notification Button -->
                    <form method="post" action="{% url 'dashboard:test_junkyard_notification' junkyard.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-warning w-full" 
                                onclick="return confirm('هل تريد إرسال رسالة اختبار للتشليح؟')">
                            <i class="fas fa-bell mr-2"></i>
                            اختبار الإشعارات
                        </button>
                    </form>
                    
                    <!-- Quick Fix Button -->
                    <a href="{% url 'dashboard:quick_fix_junkyard' junkyard.id %}" class="btn-warning w-full text-center">
                        <i class="fas fa-wrench mr-2"></i>
                        إصلاح سريع
                    </a>
                    
                    <!-- Diagnose Button -->
                    <a href="{% url 'dashboard:diagnose_junkyard_issues' junkyard.id %}" class="btn-glass w-full text-center">
                        <i class="fas fa-stethoscope mr-2"></i>
                        تشخيص مفصل
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            // Show success message
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg z-50';
            toast.textContent = 'تم نسخ الرقم بنجاح';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        });
    }
</script>
{% endblock %}